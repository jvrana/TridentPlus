import jdna
import pytest

from tridentplus import yeast


@pytest.fixture(scope='session')
def template():
    return jdna.Sequence.random(100000)


@pytest.fixture(scope='session')
def plasmid():
    return 'GTTTAAACTGGCTGCTACCCACGCCCATGGTCATAGCTGTTTCCTGTGTGAAATTGTTATCCGCTCACAATTCCACACAACATAGGAGCCGGAAGCATAAAGTGTAAAGCCTGGGGTGCCTAATGAGTGAGGTAACTCACATTAATTGCGTTGCGCTCACTGCCCGCTTTCCAGTCGGGAAACCTGTCGTGCCAGCTGCATTAATGAATCGGCCAACGCGCGGGGAGAGGCGGTTTGCGTATTGGGCGCTCTTCCGCTTCCTCGCTCACTGACTCGCTGCGCTCGGTCGTTCGGCTGCGGCGAGCGGTATCAGCTCACTCAAAGGCGGTAATACGGTTATCCACAGAATCAGGGGATAACGCAGGAAAGAACATGTGAGCAAAAGGCCAGCAAAAGGCCAGGAACCGTAAAAAGGCCGCGTTGCTGGCGTTTTTCCATAGGCTCGGCCCCCCTGACGAGCATCACAAAAATCGACGCTCAAGTCAGAGGTGGCGAAACCCGACAGGACTATAAAGATACCAGGCGTTCCCCCCTGGAAGCTCCCTCGTGCGCTCTCCTGTTCCGACCCTGCCGCTTACCGGATACCTGTCCGCCTTTCTCCCTTCGGGAAGCGTGGCGCTTTCTCAATGCTCACGCTGTAGGTATCTCAGTTCGGTGTAGGTCGTTCGCTCCAAGCTGGGCTGTGTGCACGAACCCCCCGTTCAGCCCGACCGCTGCGCCTTATCCGGTAACTATCGTCTTGAGTCCAACCCGGTAAGACACGACTTATCGCCACTGGCAGCAGCCACTGGTAACAGGATTAGCAGAGCGAGGTATGTAGGCGGTGCTACAGAGTTCTTGAAGTGGTGGCCTAACTACGGCTACACTAGAAGGACAGTATTTGGTATCTGCGCTCTGCTGAAGCCAGTTACCTTCGGAAAAAGAGTTGGTAGCTCTTGATCCGGCAAACAAACCACCGCTGGTAGCGGTGGTTTTTTTGTTTGCAAGCAGCAGATTACGCGCAGAAAAAAAGGATCTCAAGAAGATCCTTTGATCTTTTCTACGGGGTCTGACGCTCAGTGGAACGAAAACTCACGTTAAGGGATTTTGGTCATGAGATTATCAAAAAGGATCTTCACCTAGATCCTTTTAAATTAAAAATGAAGTTTTAAATCAATCTAAAGTATATATGAGTAAACTTGGTCTGACAGTTACCAATGCTTAATCAGTGAGGCACCTATCTCAGCGATCTGTCTATTTCGTTCATCCATAGTTGCCTGACTGCCCGTCGTGTAGATAACTACGATACGGGAGGGCTTACCATCTGGCCCCAGTGCTGCAATGATACCGCGAGACCCACGCTCACCGGCTCCAGATTTATCAGCAATAAACCAGCCAGCCGGAAGGGCCGAGCGCAGAAGTGGTCCTGCAACTTTATCCGCCTCCATCCAGTCTATTAATTGTTGCCGGGAAGCTAGAGTAAGTAgttcgccagttaatagtttgcgcaacgttgttgccattgctacaggcatcgtggtgtcacgctcgtcgtttggtatggcttcattcagctccggttcccaacgatcaaggcgagttacatgatcccccatgttgtgaaaaaaagcggttagctccttcggtcctccgatcgttgtcagaagtaagttggccgcagtgttatcactcatggttatggcagcactgcataattctcttactgtcatgccatccgtaagatgcttttctgtgactggtgagtactcaaccaagtcattctgagaatagtgtatgcggcgaccgagttgctcttgcccggcgtcaatacgggataataccgcgccacatagcagaactttaaaagtgctcatcattggaaaacgttcttcggggcgaaaactctcaaggatcttaccgctgttgagatccagttcgatgtaacccactcgtgcacccaactgatcttcagcatcttttactttcaccagcgtttctgggtgagcaaaaacaggaaggcaaaatgccgcaaaaaagggaataagggcgacacggaaatgttgaatactcatactcttcctttttcaatattattgaagcatttatcagggttattgtctcatgagcggatacatatttgaatgtatttagaaaaataaacaaataggggttccgcgcacatttccccgaaaagtgccacctgacgtctaagaaaccattattatcatgacattaacctataaaaataggcgtatcacgaggccctttcgtctcgcgcgtttcggtgatgacggtgaaaacctctgacacatgcagctcccggagacggtcacagcttgtctgtaagcggatgccgggagcagacaagcccgtcagggcgcgtcagcgggtgttggcgggtgtcggggctggcttaactatgcggcatcagagcagattgtactgagagtgcaccataGTCGGCGGGACCAGGGAGTTTAAACTGAATGTGTCTCTGATGTACCAGAAATAATTTCTCTTAAAGGAGGCAATGCTTGAATTTCAGGATTGAAAGTTTCATTCAATCTTGTTACAATGCCTTCCTTCTCCAAATCATTAATCAAGTGGTCAAATCTTTCATAGAACTTAGCTTCCATTCTTTTGTAGAAATCATCTACTTTCAATTTCTCGTCGCTCAGGTTAGTTACGAATGTATCATAAGAACTGAAGAGCGTCTTTCCCTCGCTACTCACAGATGAGCTGCGTGATTCAAAGAATTTCTTACGTATAAAATTCTTATTGAAAGAGGTGGTTTTCCCTTGAGGAGATAACTCGTCTAACTCAATTGTTTCCTCGTTAATATTGTTCCCATCTATGGCCTTTTCGTCGGAGTCTCCCCTTTTGCTTCCTGAAGGTGTTTTAGAACCAAAGAGCTTACGCTTGAGTTTATGTGTAAATCTTCTTTTCGATGAAGATGGTTCTCCTGCAGCTATGTTGCTTTCTATATCAGCGATTGGACCTGGAGTCTGAGAGTCAGCGTCATCGTTTAAGTCACCGGTTGGCGTTTCTTGTTTCAATTCATCTGTCTGTAATGTGTAGATCAAATTTTTCAATTCGTTATAATCTAGGTAATGATTCTGCCATTCAGGGACAGCGTTGTATTTGAGAAAGTGTGAGAATCTCATTTCGAGGCACAATAATAGCCGCCTTTACCGTAGTTTTGCTGCACCTTTATCTGAGAGCTGACTGCTTTTTTGGTGTGAAACACTGTTTTCTGGTAATAATTTTTCAATGCATCGGATTACTTTTCCCACGTGCGAAATCATCAATTAATTAGATTGAAAAAAGGGTAAGGGAAAATAAGAAAGAGGCGGTAGCCTAAAGATACGGTAATTGAAACGTTTCCTATGCACAATCTTAAACCTTTTTAGGTAATTGATTAAGTTGACTGTAATATCTGTAAAAGATTACATCTAATTTACGTCTGGTTTCTGCCGATACGAAGGTTTTCTCCAGCGAGTTTATCATTATCAATACTCGCCATTTCAAAGAATACGTAAATAATTAATAGTAGTGATTTTCCTAACTTTATTTAGTCAAAAAATTAGCCTTTTAATTCTGCTGTAACCCGTACATGCCCAAAATAGGGGGCGGGTTACACAGAATATATAACATCGTAGGTGTCTGGGTGAACAGTTTATTCCTGGCATCCACTAAATATAATGGAGCCCGCTTTTTAAGCTGGCATCCAGAAAAAAAAAGAATCCCAGCACCAAAATATTGTTTTCTTCACCAACCATCAGTTCATAGGTCCATTCTCTTAGCGCAACTACAGAGAACAGGGGCACAAACAGGCAAAAAACGGGCACAACCTCAATGGAGTGATGCAACCTGCCTGGAGTAAATGATGACACAAGGCAATTGACCCACGCATGTATCTATCTCATTTTCTTACACCTTCTATTACCTTCTGCTCTCTCTGATTTGGAAAAAGCTGAAAAAAAAGGTTGAAACCAGTTCCCTGAAATTATTCCCCTACTTGACTAATAAGTATATAAAGACGGTAGGTATTGATTGTAATTCTGTAAATCTATTTCTTAAACTTCTTAAATTCTACTTTTATAGTTAGTCTTTTTTTTAGTTTTAAAACACCAGAACTTAGTTTCGACGGGACCGTCAACCCTGAACCACAAAATGTCTAAAGGTGAAGAATTATTCACTGGTGTTGTCCCAATTTTGGTTGAATTAGATGGTGATGTTAATGGTCACAAATTTTCTGTCTCCGGTGAAGGTGAAGGTGATGCTACTTACGGTAAATTGACCTTAAAATTGATTTGTACTACTGGTAAATTGCCAGTTCCATGGCCAACCTTAGTCACTACTTTAGGTTATGGTTTGCAATGTTTTGCTAGATACCCAGATCATATGAAACAACATGACTTTTTCAAGTCTGCCATGCCAGAAGGTTATGTTCAAGAAAGAACTATTTTTTTCAAAGATGACGGTAACTACAAGACCAGAGCTGAAGTCAAGTTTGAAGGTGATACCTTAGTTAATAGAATCGAATTAAAAGGTATTGATTTTAAAGAAGATGGTAACATTTTAGGTCACAAATTGGAATACAACTATAACTCTCACAATGTTTACATCACTGCTGACAAACAAAAGAATGGTATCAAAGCTAACTTCAAAATTAGACACAACATTGAAGATGGTGGTGTTCAATTAGCTGACCATTATCAACAAAATACTCCAATTGGTGATGGTCCAGTCTTGTTACCAGACAACCATTACTTATCCTATCAATCTGCCTTATCCAAAGATCCAAACGAAAAGAGAGACCACATGGTCTTGTTAGAATTTGTTACTGCTGCTGGTATTACCCATGGTATTGATGAATTGTACAAATGAGCAGGCATCGAGTGAAGTCAACATTAGTTATGTCACGCTTACATTCACGCCCTCCCCCCACATCCGCTCTAACCGAAAAGGAAGGAGTTAGACAACCTGAAGTCTAGGTCCCTATTTATTTTTTTATAGTTATGTTAGTATTAAGAACGTTATTTATATTTCAAATTTTTCTTTTTTTTCTGTACAGACGCGTGTACGCATGTAACATTATACTGAAAACCTTGCTTGAGAAGGTTTTGGGACGCTCGAAGGCTTTAATTTGCTTCAATAAAGGAGCGAGCACCCGCCTGAGGGGCGCGCCAGATCTGTTTAGCTTGCCTCGTCCCCGCCGGGTCACCCGGCCAGCGACATGGAGGCCCAGAATACCCTCCTTGACAGTCTTGACGTGCGCAGCTCAGGGGCATGATGTGACTGTCGCCCGTACATTTAGCCCATACATCCCCATGTATAATCATTTGCATCCATACATTTTGATGGCCGCACGGCGCGAAGCAAAAATTACGGCTCCTCGCTGCAGACCTGCGAGCAGGGAAACGCTCCCCTCACAGACGCGTTGAATTGTCCCCACGCCGCGCCCCTGTAGAGAAATATAAAAGGTTAGGATTTGCCACTGAGGTTCTTCTTTCATATACTTCCTTTTAAAATCTTGCTAGGATACAGTTCTCACATCACATCCGAACATAAACAACCatgggtatgaccgaccaagcgacgcccaacctgccatcacgagatttcgatcccaccgccgccttctatgaaaggttgggcttcggaatcgttttccgggacgccggctggatgatcctccagcgcggggatctcatgctggagttcttcgcccaccccgggctcgatcccctcgcgagttggttcagctgctgcctgaggctggacgacctcgcggagttctaccggcagtgcaaatccgtcggcatccaggaaaccagcagcggctatccgcgcatccatgcccccgaactgcaggagtggggaggcacgatggccgctttggtcgacccggacgggacgctcctgcgcctgatacagaacgaattgcttgcaggcatctcatgaTCAGTACTGACAATAAAAAGATTCTTGTTTTCAAGAACTTGTCATTTGTATAGTTTTTTTATATTGTAGTTGTTCTATTTTAATCAAATGTTAGCGTGATTTATATTTTTTTTCGCCTCGACATCATCTGCCCAGATGCGAAGTTAAGTGCGCAGAAAGTAATATCATGCGTCAATCGTATGTGAATGCTGGTCGCTATACTGCTGTCGATTCGATACTAACGCCGCCATCCAGTGTCCAGAAGCGAGGCGAATAAAGGTGGCATTATCTACTGTAGTTATGCAAGTATTCTTAATTTTCAGTACTAAACATGAATATTAATTATTTGTGAGCGTACAAGAAGCAAAAGGAAGTCATCTTTCTTTGAACAGTTCTGTTTTTAGGTAAGCCTTGGAACCTTAGCTATACTGACTTGATACGCCCTGTCTTTGTTGTCGTTATATAAAGTGTGCACCTTTATCATAGCCCCTAATAAGCTTCTTGCAGTAGTATTTGAACAGTGTATATCTTCATATTGCTTTTGTTGTAAATATTGCGCAAAAGCGACTATCTTTGTGATTTGGTTGAACTTTTGCATATTCACGTTATTACCATCTTTAGTGAATGTATCGTTTCCGTCTCTTATGAAGGTAATGTCCCTGATAAGCAGTGATGTAAAAGGTACACAAGGAAGCTGACTGTGGAAAATATGTTTAATTGTTCTTCTATAAACGTTGTAGTTGTTGTTTGGATGTACGACGACTTTTAGGCGCTGAAAAAGGTGGTCTGATTTAACATCTATCGGGAGAGATAGTCTTTCTATTGAATGATTTTGCAATGATGTAATGATTGAAGCAAGTGAGTTTAAGTTTCGTAAGTATAGACAAGACAGTGCAACTTGTAACCAGTAGGAAATGGTGTGCGTTTGCTGCAAAGTTGTCTCAAGAACGTAGGACGATAACTGGTTGGAAAGCGTAAACACGGAGTCAATTGTTGTATCGTTGTGTTTGAAATGTCTTGTGAATTCTATTGTTTCAATATCCAAGTAAAGAGAAGATTCTAAGAGAGTCAATGTCTTTGCAAGTGACCATGGAGATACGTTTAGAGCGAAGGCTTCGACTTCTAGAAGTTCACCCTGTTTCCATTGGAAAAGTAAATCACTGAGGTCAGTTGCACCGCACAATTCATCATTTGCGTTCGTTTTGTCTATCTCGTATTGGAGAAATAAGTTTTCGTAGTCCAGGGGCGGTTTATTTTCTTCGA'


def test_align_to_genome(plasmid):
    aligner = yeast.align_to_genome([plasmid])
    assert len(aligner.results)


@pytest.mark.parametrize('h1,h2,rc1,rc2,expected', [
    ((1000, 1500), (1510, 2000), False, False, True),
    ((1000, 1500), (1510, 2000), True, False, False),
    ((1000, 1500), (1510, 2000), False, True, False),
    ((1000, 1500), (1510, 2000), True, True, False),
    ((1510, 2000), (1000, 1500), True, True, True),
])
def test_integration_sites(template, h1, h2, rc1, rc2, expected):
    h1seq = template[h1[0]:h1[1]]
    h2seq = template[h2[0]:h2[1]]
    if rc1:
        h1seq.rc()
    if rc2:
        h2seq.rc()

    integrant = jdna.Sequence.random(2000)

    plasmid = h1seq + integrant + h2seq
    a = yeast.align([str(plasmid)], [str(template)])
    sites = yeast.alignments_to_integration_sites(a.results.alignments)
    if expected:
        assert len(sites)
    else:
        assert len(sites) == 0


@pytest.mark.parametrize('h1,h2,rc1,rc2,expected', [
    ((1000, 1500), (1510, 2000), False, False, True),
    ((1000, 1500), (1510, 2000), True, False, False),
    ((1000, 1500), (1510, 2000), False, True, False),
    ((1000, 1500), (1510, 2000), True, True, False),
    ((1510, 2000), (1000, 1500), True, True, True),
])
def test_integration(template, h1, h2, rc1, rc2, expected):
    h1seq = template[h1[0]:h1[1]]
    h2seq = template[h2[0]:h2[1]]
    if rc1:
        h1seq.rc()
    if rc2:
        h2seq.rc()

    integrant = jdna.Sequence.random(2000)

    plasmid = h1seq + integrant + h2seq

    seqs = yeast.homologous_recombination(plasmid, template)
    if expected:
        assert seqs
    else:
        assert not seqs


def test_genomic_integration(plasmid):
    seq = jdna.Sequence(plasmid)
    seqs = yeast.genomic_integration(seq)
    print(seqs)
